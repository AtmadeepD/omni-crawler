<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article Details - OmniCrawler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .article-header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 20px 20px;
        }
        .quality-badge { font-size: 0.9rem; }
        .content-area { 
            line-height: 1.8; 
            font-size: 1.1rem;
            font-family: 'Georgia', serif;
        }
        .metadata-card { 
            background: #f8f9fa;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .article-image {
            max-height: 400px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        .sentiment-positive { color: #28a745; }
        .sentiment-negative { color: #dc3545; }
        .sentiment-neutral { color: #ffc107; }
        .back-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
        }
        .back-button:hover {
            background: rgba(255,255,255,0.3);
            color: white;
        }
        .tag-badge {
            background: #e9ecef;
            color: #495057;
            margin: 0.1rem;
        }
        .key-phrase-badge {
            background: #007bff;
            color: white;
            margin: 0.1rem;
        }
        .content-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .stat-item {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        /* Content formatting styles */
        .content-heading {
            color: #2c3e50;
            border-left: 4px solid #007bff;
            padding-left: 1rem;
            font-weight: 600;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        .content-paragraph {
            line-height: 1.8;
            text-align: justify;
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 1.5rem;
        }

        .content-list {
            margin: 1rem 0;
            padding-left: 2rem;
            list-style-type: disc;
        }

        .content-list-item {
            margin-bottom: 0.5rem;
            line-height: 1.6;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .content-list-item::marker {
            color: #007bff;
            font-weight: bold;
        }

        /* Stats grid improvements */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-item {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            display: block;
        }

        /* Article meta improvements */
        .article-meta .badge {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-globe"></i> OmniCrawler
            </a>
            <div class="navbar-nav ms-auto">
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <!-- Article Container -->
    <div class="container-fluid px-0">
        <!-- Loading State -->
        <div id="loading-state" class="text-center py-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h4 class="mt-3">Loading Article Details...</h4>
            <p class="text-muted">Please wait while we fetch the complete article information.</p>
        </div>

        <!-- Article Content (initially hidden) -->
        <div id="article-content" style="display: none;">
            <!-- Article Header -->
            <div class="article-header">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-8">
                            <nav aria-label="breadcrumb" class="mb-3">
                                <ol class="breadcrumb">
                                    <li class="breadcrumb-item"><a href="/" class="text-light">Dashboard</a></li>
                                    <li class="breadcrumb-item active text-light" id="breadcrumb-category">Article</li>
                                </ol>
                            </nav>
                            
                            <h1 class="display-5 fw-bold mb-3" id="article-title">Loading Title...</h1>
                            
                            <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                                <span class="badge bg-light text-dark" id="article-domain">
                                    <i class="fas fa-globe"></i> Loading...
                                </span>
                                <span class="badge bg-primary" id="article-category">
                                    <i class="fas fa-tag"></i> Loading...
                                </span>
                                <span class="badge bg-warning text-dark" id="article-quality">
                                    <i class="fas fa-star"></i> Quality: Loading...
                                </span>
                                <span class="badge bg-info" id="article-sentiment">
                                    <i class="fas fa-smile"></i> Loading...
                                </span>
                            </div>

                            <div class="d-flex flex-wrap gap-3 align-items-center text-light">
                                <div id="article-authors">
                                    <i class="fas fa-user-edit"></i>
                                    <span>Loading authors...</span>
                                </div>
                                <div id="article-published">
                                    <i class="fas fa-calendar"></i>
                                    <span>Loading date...</span>
                                </div>
                                <div id="article-reading-time">
                                    <i class="fas fa-clock"></i>
                                    <span>Loading reading time...</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                            <a href="#" id="article-source-url" target="_blank" class="btn btn-light btn-lg">
                                <i class="fas fa-external-link-alt"></i> Visit Original Source
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="container mt-4">
                <div class="row">
                    <!-- Article Content Column -->
                    <div class="col-lg-8">
                        <!-- Featured Image -->
                        <div id="article-image-container" class="mb-4" style="display: none;">
                            <img id="article-image" class="article-image w-100" src="" alt="Article featured image">
                        </div>

                        <!-- Quick Stats -->
                        <div class="stats-grid mb-4">
                            <div class="stat-item">
                                <span class="stat-value" id="stat-word-count">0</span>
                                <span class="stat-label">Words</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="stat-reading-time">0</span>
                                <span class="stat-label">Minutes</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="stat-content-length">0</span>
                                <span class="stat-label">Characters</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="stat-language">EN</span>
                                <span class="stat-label">Language</span>
                            </div>
                        </div>

                        <!-- Article Content -->
                        <div class="content-section">
                            <h3 class="mb-4">
                                <i class="fas fa-file-alt text-primary"></i> Article Content
                            </h3>
                            <div class="content-area" id="article-content-text">
                                <div class="text-center py-4">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading content...</span>
                                    </div>
                                    <p class="mt-2">Loading article content...</p>
                                </div>
                            </div>
                        </div>

                        <!-- AI Summary -->
                        <div class="content-section" id="summary-section" style="display: none;">
                            <h3 class="mb-4">
                                <i class="fas fa-robot text-success"></i> AI Summary
                            </h3>
                            <div class="alert alert-success">
                                <p class="lead mb-0" id="article-summary">Loading summary...</p>
                            </div>
                        </div>

                        <!-- Key Phrases -->
                        <div class="content-section" id="key-phrases-section" style="display: none;">
                            <h3 class="mb-4">
                                <i class="fas fa-key text-warning"></i> Key Phrases
                            </h3>
                            <div id="key-phrases-container">
                                <!-- Key phrases will be inserted here -->
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar Column -->
                    <div class="col-lg-4">
                        <!-- Article Information Card -->
                        <div class="metadata-card sticky-top" style="top: 20px;">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="fas fa-info-circle text-primary"></i> Article Information
                                </h5>
                                
                                <div class="mb-3">
                                    <strong><i class="fas fa-database"></i> Article ID</strong>
                                    <p class="text-muted font-monospace small" id="info-article-id">Loading...</p>
                                </div>

                                <div class="mb-3">
                                    <strong><i class="fas fa-calendar-check"></i> Processed</strong>
                                    <p class="text-muted" id="info-processed-date">Loading...</p>
                                </div>

                                <div class="mb-3">
                                    <strong><i class="fas fa-language"></i> Language</strong>
                                    <p class="text-muted" id="info-language">Loading...</p>
                                </div>

                                <div class="mb-3">
                                    <strong><i class="fas fa-chart-bar"></i> Quality Score</strong>
                                    <div class="progress mt-1">
                                        <div id="quality-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted" id="quality-text">0/100</small>
                                </div>

                                <div class="mb-3">
                                    <strong><i class="fas fa-feather"></i> Word Count</strong>
                                    <p class="text-muted" id="info-word-count">Loading...</p>
                                </div>

                                <div class="mb-3">
                                    <strong><i class="fas fa-ruler"></i> Content Length</strong>
                                    <p class="text-muted" id="info-content-length">Loading...</p>
                                </div>

                                <!-- Tags Section -->
                                <div id="tags-section" style="display: none;">
                                    <strong><i class="fas fa-tags"></i> Tags</strong>
                                    <div class="mt-2" id="tags-container">
                                        <!-- Tags will be inserted here -->
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="mt-4 pt-3 border-top">
                                    <button onclick="window.print()" class="btn btn-outline-secondary btn-sm w-100 mb-2">
                                        <i class="fas fa-print"></i> Print Article
                                    </button>
                                    <button onclick="shareArticle()" class="btn btn-outline-primary btn-sm w-100">
                                        <i class="fas fa-share-alt"></i> Share
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="error-state" class="container text-center py-5" style="display: none;">
            <div class="alert alert-danger">
                <h4><i class="fas fa-exclamation-triangle"></i> Error Loading Article</h4>
                <p id="error-message">Unable to load article details. Please try again later.</p>
                <a href="/" class="btn btn-primary">
                    <i class="fas fa-arrow-left"></i> Return to Dashboard
                </a>
            </div>
        </div>
    </div>

    <script>
        // Get article ID from template
        const articleId = '{{ article_id }}';
        
        // DOM elements
        const loadingState = document.getElementById('loading-state');
        const articleContent = document.getElementById('article-content');
        const errorState = document.getElementById('error-state');
        const errorMessage = document.getElementById('error-message');

        // Load article data
        async function loadArticle() {
            try {
                console.log('Loading article:', articleId);
                const response = await fetch(`/api/articles/${articleId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const article = await response.json();
                
                if (article.error) {
                    throw new Error(article.error);
                }
                
                // Render the article
                renderArticle(article);
                
            } catch (error) {
                console.error('Failed to load article:', error);
                showError(error.message);
            }
        }

        // Safe helpers to avoid undefined errors
        const asNumber = (value, fallback = 0) => {
            const n = Number(value);
            return Number.isFinite(n) ? n : fallback;
        };
        const asString = (value, fallback = '') => {
            return (typeof value === 'string' && value.length > 0) ? value : (value ?? fallback);
        };
        const formatNumber = (value, fallback = 0) => asNumber(value, fallback).toLocaleString();
        const toUpperSafe = (value, fallback = 'en') => asString(value, fallback).toUpperCase();

        function renderArticle(article) {
            // Update basic information
            const safeTitle = asString(article.title, 'Untitled');
            document.getElementById('article-title').textContent = safeTitle;
            document.title = `${safeTitle} - OmniCrawler`;
            
            // Update breadcrumb
            document.getElementById('breadcrumb-category').textContent = asString(article.category, 'Article');
            
            // Update badges
            document.getElementById('article-domain').innerHTML = `<i class="fas fa-globe"></i> ${asString(article.domain, 'Unknown Domain')}`;
            document.getElementById('article-category').innerHTML = `<i class="fas fa-tag"></i> ${asString(article.category, 'general')}`;
            const safeQuality = asNumber(article.quality_score, 0);
            document.getElementById('article-quality').innerHTML = `<i class="fas fa-star"></i> Quality: ${safeQuality}`;
            
            // Update sentiment with appropriate icon and color
            const sentimentIcon = {
                'positive': 'fa-smile sentiment-positive',
                'negative': 'fa-frown sentiment-negative',
                'neutral': 'fa-meh sentiment-neutral'
            }[article.sentiment] || 'fa-meh sentiment-neutral';
            
            document.getElementById('article-sentiment').innerHTML = 
                `<i class="fas ${sentimentIcon}"></i> ${article.sentiment}`;

            // Update authors
            const authorsElement = document.getElementById('article-authors');
            if (Array.isArray(article.authors) && article.authors.length > 0) {
                authorsElement.innerHTML = `<i class="fas fa-user-edit"></i> By ${article.authors.join(', ')}`;
            } else {
                authorsElement.style.display = 'none';
            }

            // Update dates
            const publishedElement = document.getElementById('article-published');
            if (article.published_date) {
                publishedElement.innerHTML = `<i class="fas fa-calendar"></i> ${new Date(article.published_date).toLocaleDateString()}`;
            } else if (article.processed_at) {
                publishedElement.innerHTML = `<i class="fas fa-calendar"></i> ${new Date(article.processed_at).toLocaleDateString()}`;
            } else {
                publishedElement.style.display = 'none';
            }

            // Update reading time
            const safeWordCount = asNumber(article.word_count, 0);
            const safeReadingTime = asNumber(article.reading_time, Math.max(1, Math.ceil(safeWordCount / 200)) || 5);
            document.getElementById('article-reading-time').innerHTML = 
                `<i class="fas fa-clock"></i> ${safeReadingTime} min read`;

            // Update source URL
            const sourceLink = document.getElementById('article-source-url');
            sourceLink.href = asString(article.url, '#');
            sourceLink.textContent = `Visit ${asString(article.domain, 'source')}`;

            // Update stats
            document.getElementById('stat-word-count').textContent = formatNumber(article.word_count, 0);
            document.getElementById('stat-reading-time').textContent = safeReadingTime;
            document.getElementById('stat-content-length').textContent = formatNumber(article.content_length, 0);
            document.getElementById('stat-language').textContent = toUpperSafe(article.language, 'en');

            // Update content
            document.getElementById('article-content-text').innerHTML = 
                formatContent(article.content || 'No content available for this article.');

            // Update summary if available
            const summarySection = document.getElementById('summary-section');
            if (article.summary && article.summary.trim().length > 0) {
                document.getElementById('article-summary').textContent = article.summary;
                summarySection.style.display = 'block';
            }

            // Update key phrases if available
            const keyPhrasesSection = document.getElementById('key-phrases-section');
            const keyPhrasesContainer = document.getElementById('key-phrases-container');
            if (article.key_phrases && article.key_phrases.length > 0) {
                keyPhrasesContainer.innerHTML = article.key_phrases.map(phrase => 
                    `<span class="badge key-phrase-badge">${phrase}</span>`
                ).join('');
                keyPhrasesSection.style.display = 'block';
            }

            // Update image if available
            const imageContainer = document.getElementById('article-image-container');
            const imageElement = document.getElementById('article-image');
            if (article.image_url && article.image_url.trim().length > 0) {
                imageElement.src = article.image_url;
                imageElement.alt = `Featured image for ${article.title}`;
                imageContainer.style.display = 'block';
            }

            // Update sidebar information
            document.getElementById('info-article-id').textContent = article.id;
            document.getElementById('info-processed-date').textContent = 
                article.processed_at ? new Date(article.processed_at).toLocaleString() : 'Unknown';
            document.getElementById('info-language').textContent = toUpperSafe(article.language, 'en');
            document.getElementById('info-word-count').textContent = formatNumber(article.word_count, 0) + ' words';
            document.getElementById('info-content-length').textContent = formatNumber(article.content_length, 0) + ' characters';

            // Update quality progress bar
            const qualityProgress = document.getElementById('quality-progress');
            const qualityText = document.getElementById('quality-text');
            qualityProgress.style.width = `${safeQuality}%`;
            qualityProgress.className = `progress-bar ${
                safeQuality >= 80 ? 'bg-success' : 
                safeQuality >= 60 ? 'bg-warning' : 'bg-danger'
            }`;
            qualityText.textContent = `${safeQuality}/100`;

            // Update tags if available
            const tagsSection = document.getElementById('tags-section');
            const tagsContainer = document.getElementById('tags-container');
            if (article.tags && article.tags.length > 0) {
                tagsContainer.innerHTML = article.tags.map(tag => 
                    `<span class="badge tag-badge">${tag}</span>`
                ).join('');
                tagsSection.style.display = 'block';
            }

            // Show content and hide loading
            loadingState.style.display = 'none';
            articleContent.style.display = 'block';
        }

        function formatContent(content) {
            if (!content) return '<p class="text-muted">No content available for this article.</p>';
            
            // Clean up the content
            let cleanedContent = content
                .replace(/\n\s*\n/g, '\n\n') // Normalize multiple newlines
                .replace(/^\s+|\s+$/g, ''); // Trim whitespace
            
            const paragraphs = cleanedContent.split('\n\n');
            
            let formattedContent = '';
            let inList = false;
            
            paragraphs.forEach((paragraph, index) => {
                const trimmed = paragraph.trim();
                if (!trimmed) return;
                
                // Detect list items (bullet points, numbered lists, or lines starting with capital words + colon)
                if (/^[•\-*\d]+\.?\s/.test(trimmed) || /^[A-Z][a-z]+:/.test(trimmed)) {
                    if (!inList) {
                        formattedContent += '<ul class="content-list">';
                        inList = true;
                    }
                    formattedContent += `<li class="content-list-item">${trimmed.replace(/^[•\-*\d]+\.?\s/, '')}</li>`;
                } else {
                    if (inList) {
                        formattedContent += '</ul>';
                        inList = false;
                    }
                    
                    // Detect headings (short paragraphs that look like section titles)
                    const isHeading = (
                        trimmed.length < 150 && 
                        (trimmed.endsWith(':') || 
                         trimmed.endsWith('?') ||
                         /^(What|How|Why|When|Where|Key|Major|Sticking|Future|Israeli|Hamas|Trump)/i.test(trimmed) ||
                         !trimmed.includes('.') && trimmed.split(' ').length < 15)
                    );
                    
                    if (isHeading) {
                        formattedContent += `<h4 class="content-heading mt-4 mb-3">${trimmed}</h4>`;
                    } else {
                        // Regular paragraph
                        formattedContent += `<p class="content-paragraph mb-3">${trimmed}</p>`;
                    }
                }
            });
            
            // Close any open list
            if (inList) {
                formattedContent += '</ul>';
            }
            
            return formattedContent || `<p class="content-paragraph">${content}</p>`;
        }

        function showError(message) {
            loadingState.style.display = 'none';
            articleContent.style.display = 'none';
            errorMessage.textContent = message || 'Unable to load article details. Please try again later.';
            errorState.style.display = 'block';
        }

        function shareArticle() {
            if (navigator.share) {
                navigator.share({
                    title: document.getElementById('article-title').textContent,
                    text: document.getElementById('article-summary')?.textContent || '',
                    url: window.location.href
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('Article link copied to clipboard!');
                });
            }
        }

        // Load article when page loads
        document.addEventListener('DOMContentLoaded', loadArticle);
    </script>
</body>
</html>